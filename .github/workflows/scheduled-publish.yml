name: 定时发布文章
on:
  schedule:
    - cron: '*/15 * * * *'   # 北京时间 07:58
  workflow_dispatch:

jobs:
  public:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.ACCESS_TOKEN }}  # 使用 ACCESS_TOKEN 拉取代码，确保后续推送权限一致

      - name: Set Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: 安装依赖项
        run: npm ci

      - name: 运行检查脚本
        run: node .github/scripts/publish-check.cjs

      - name: 推送更新的文件
        run: |
          # 配置 git 用户信息（仅用于提交记录）
          git config --local user.email "zhanghaoyu19281@outlook.com"
          git config --local user.name "AeYunDian"

          # 添加所有更改
          git add .

          # 检查是否有更改需要提交
          if ! git diff --cached --quiet; then
            git commit -m "chore: auto publish scheduled articles"

            # 重新设置远程仓库 URL，使用 ACCESS_TOKEN 进行认证
            REPO_URL="https://x-access-token:${{ secrets.ACCESS_TOKEN }}@github.com/${{ github.repository }}.git"
            git remote set-url origin "$REPO_URL"

            # 推送到 main 分支
            git push origin main
          else
            echo "没有需要提交的更改"
          fi